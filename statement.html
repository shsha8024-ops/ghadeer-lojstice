<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ø§Ù… | Ø´Ø±ÙƒØ© Ø§Ù„ØºØ¯ÙŠØ± Ù„Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„ØªØ®Ù„ÙŠØµ Ø§Ù„ÙƒÙ…Ø±ÙƒÙŠ</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
body {
  font-family: "Cairo", sans-serif;
  background: linear-gradient(180deg,#f7faff,#eef5ff);
  color: #000;
  margin: 0;
  min-height: 100vh;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
}
header {
  background: linear-gradient(90deg,#003366,#004b95);
  color: #fff;
  padding: 1.5rem 3rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  border-bottom: 3px solid #c2a356;
}
.brand {display:flex;align-items:center;gap:16px}
.brand img{width:70px;height:70px;object-fit:contain}
.brand-name span{font-size:1.5rem;font-weight:900;}
.brand-name small{color:#f8e9b3;font-size:.95rem}
main {
  flex: 1;
  max-width: 1200px;
  margin: 2rem auto;
  padding: 1.5rem;
  width: 95%;
}
h2 {
  text-align: center;
  color: #004b95;
  border-bottom: 2px solid #c2a356;
  padding-bottom: 6px;
  margin-bottom: 1rem;
}
.search-bar {text-align:center;margin-bottom:1.5rem;}
.search-bar input {
  width: 70%;
  max-width: 450px;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid #ccc;
  background: #fff;
  color: #000;
  font-size: 1rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 4px 25px rgba(0,0,0,0.1);
}
th, td {
  padding: 12px;
  border-bottom: 1px solid #eee;
  text-align: center;
  font-size: 1rem;
}
th {background:#f2f6fb;color:#003366;font-weight:700;}
button {
  border:none;border-radius:8px;padding:8px 16px;
  cursor:pointer;font-weight:600;transition:0.3s;
}
.view-btn {background:linear-gradient(90deg,#004b95,#008d5f);color:#fff;}
.view-btn:hover{background:#008d5f;}
.pdf-btn {background:linear-gradient(90deg,#b9973e,#f0cd63);color:#000;}
.back-btn {background:#004b95;color:#fff;}
.save-btn {background:#006400;color:#fff;}
.load-btn {background:#8b0000;color:#fff;}
.buttons {text-align:center;margin:1.5rem 0;}
input[type="file"]{display:none;}
footer {
  background:#fafafa;text-align:center;padding:1.5rem;color:#000;
  border-top:1px solid #ddd;font-size:.95rem;
}
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="ghadeer-logo.png" alt="ghadeer logo">
    <div class="brand-name">
      <span>Ø´Ø±ÙƒØ© Ø§Ù„ØºØ¯ÙŠØ±</span><br>
      <small>Ù„Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„ØªØ®Ù„ÙŠØµ Ø§Ù„ÙƒÙ…Ø±ÙƒÙŠ</small>
    </div>
  </div>
</header>

<main id="pdfContent">
  <h2>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ø§Ù…</h2>

  <div class="search-bar">
    <input type="text" id="searchBox" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„...">
  </div>

  <div class="buttons">
    <button class="save-btn" onclick="exportBackup()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
    <label class="load-btn" for="backupFile">ğŸ“‚ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
    <input type="file" id="backupFile" accept=".json" onchange="importBackup(event)">
    <button class="pdf-btn" onclick="generatePDF()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
    <button class="back-btn" onclick="window.location.href='home.html'">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
  </div>

  <table id="clientsTable">
    <thead>
      <tr>
        <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØµÙˆÙ„Ø§Øª ($)</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø¨ÙˆØ¶Ø§Øª ($)</th>
        <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ($)</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<footer>
  Ø²Ø§Ø®Ùˆ - Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø§Ù„Ø®Ù„ÙŠÙ„ ğŸ“ 07504084359 â€¢ ğŸ“§ starzeki001@gmail.com  
  <br>Â© 2026 Ø´Ø±ÙƒØ© Ø§Ù„ØºØ¯ÙŠØ± Ù„Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„ØªØ®Ù„ÙŠØµ Ø§Ù„ÙƒÙ…Ø±ÙƒÙŠ â€“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
</footer>

<script>
let allReceipts = JSON.parse(localStorage.getItem('ghadeerAllReceipts') || '[]');
let invoices = JSON.parse(localStorage.getItem('ghadeerInvoices') || '[]');
let clientsMap = {};

function buildData(){
  clientsMap={};
  invoices.forEach(inv=>{
    if(!inv.client) return;
    if(!clientsMap[inv.client]) clientsMap[inv.client]={receipts:0,payments:0};
    if(inv.receipts){inv.receipts.forEach(r=>clientsMap[inv.client].receipts+=r.amount);}
  });
  allReceipts.forEach(r=>{
    if(!r.client) return;
    if(!clientsMap[r.client]) clientsMap[r.client]={receipts:0,payments:0};
    clientsMap[r.client].payments+=r.amount;
  });
}

function renderTable(){
  const search=document.getElementById('searchBox').value.toLowerCase();
  const tbody=document.querySelector('#clientsTable tbody');
  tbody.innerHTML='';
  Object.keys(clientsMap)
    .filter(name=>name.toLowerCase().includes(search))
    .forEach(name=>{
      const r=clientsMap[name];
      const balance=r.receipts - r.payments;
      tbody.innerHTML+=`
      <tr>
        <td>${name}</td>
        <td>${r.receipts.toFixed(2)}</td>
        <td>${r.payments.toFixed(2)}</td>
        <td>${balance.toFixed(2)}</td>
        <td><button class="view-btn" onclick="openClient('${name}')">ğŸ“„ Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ø¹Ù…ÙŠÙ„</button></td>
      </tr>`;
    });
  localStorage.setItem('lastSearch', search);
}

function openClient(name){
  localStorage.setItem('currentClient', name);
  localStorage.setItem('lastPage', 'statement.html');
  window.location.href='client-account1.html';
}

// === PDF ===
function generatePDF(){
  const dateStr=new Date().toLocaleString('ar-IQ');
  html2pdf().set({
    margin:0.3,
    filename:`ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¹Ø§Ù… ${dateStr}.pdf`,
    image:{type:'jpeg',quality:0.98},
    html2canvas:{scale:2},
    jsPDF:{unit:'in',format:'a4',orientation:'portrait'}
  }).from(document.getElementById('pdfContent')).save();
}

// === Manual Backup ===
function exportBackup(){
  const data={
    receipts:allReceipts,
    invoices:invoices,
    currentClient:localStorage.getItem('currentClient')||null,
    lastPage:localStorage.getItem('lastPage')||null,
    lastSearch:localStorage.getItem('lastSearch')||'',
    savedAt:new Date().toLocaleString('ar-IQ')
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`ghadeer-backup-${Date.now()}.json`;
  a.click();
  alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
}

// === Manual Restore ===
function importBackup(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      if(d.receipts&&d.invoices){
        localStorage.setItem('ghadeerAllReceipts',JSON.stringify(d.receipts));
        localStorage.setItem('ghadeerInvoices',JSON.stringify(d.invoices));
        if(d.currentClient)localStorage.setItem('currentClient',d.currentClient);
        if(d.lastSearch)localStorage.setItem('lastSearch',d.lastSearch);
        if(d.lastPage)localStorage.setItem('lastPage',d.lastPage);
        alert("âœ… ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
        location.reload();
      }else alert("âš ï¸ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.");
    }catch(err){alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„.");}
  };
  r.readAsText(f);
}

// === Auto Backup on Exit ===
window.addEventListener("beforeunload", ()=>{
  const autoData={
    receipts:allReceipts,
    invoices:invoices,
    currentClient:localStorage.getItem('currentClient'),
    lastPage:'statement.html',
    lastSearch:document.getElementById('searchBox').value,
    savedAt:new Date().toLocaleString('ar-IQ')
  };
  localStorage.setItem("ghadeerAutoBackup", JSON.stringify(autoData));
});

// === Auto Restore on Load ===
window.addEventListener("load", ()=>{
  const auto=localStorage.getItem("ghadeerAutoBackup");
  if(auto){
    const data=JSON.parse(auto);
    const lastSearch=data.lastSearch||'';
    document.getElementById('searchBox').value=lastSearch;
    if(confirm(`ğŸ’¡ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø³Ø®Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø© Ø¨ØªØ§Ø±ÙŠØ® ${data.savedAt}\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ØŸ`)){
      localStorage.setItem('ghadeerAllReceipts', JSON.stringify(data.receipts));
      localStorage.setItem('ghadeerInvoices', JSON.stringify(data.invoices));
      if(data.currentClient)localStorage.setItem('currentClient',data.currentClient);
      alert("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§!");
      location.reload();
    }
  }else{
    const lastSearch=localStorage.getItem('lastSearch')||'';
    document.getElementById('searchBox').value=lastSearch;
  }
});

document.getElementById('searchBox').addEventListener('input',renderTable);
buildData();renderTable();
</script>
</body>
</html>